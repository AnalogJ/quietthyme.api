machine:
  services:
    - docker
  node:
    version: 6.1.0

dependencies:
  override:
    - npm install -g serverless
    - npm install
    - npm ls || true
# pull docker images needed for tests.
    - docker pull vidsyhq/fake-dynamodb
    - docker pull lphoward/fake-s3
    - docker pull analogj/docker-amazonlinux-node

test:
  override:
    - docker run -d -p 6001:6001 vidsyhq/fake-dynamodb
    - docker run -d -p 4569:4569 lphoward/fake-s3
    - sleep 2
    - curl localhost:6001
    - curl localhost:4569
    - npm run-script coveralls

deployment:
  deploy:
    branch: [beta, master]
    commands:
      - sls prune -n 4
      - rm -rf node_modules
      - docker run -v `pwd`:/var/task -e CIRCLE_SHA1 -e AWS_ACCESS_KEY_ID -e AWS_REGION -e AWS_SECRET_ACCESS_KEY -e ENCRYPTION_JWT_PASSPHRASE -e ENCRYPTION_PASSPHRASE -e OAUTH_GOODREADS_CLIENT_KEY -e OAUTH_GOODREADS_CLIENT_SECRET -e beta_KLOUDLESS_API_ID -e beta_KLOUDLESS_API_KEY -e beta_STORAGE_SALT -e beta_STRIPE_SECRET_KEY analogj/docker-amazonlinux-node npm install --prod && npm ls || true && serverless deploy --stage $CIRCLE_BRANCH --region us-east-1
      - aws s3api put-bucket-lifecycle-configuration  --bucket quietthyme-api-${CIRCLE_BRANCH}-upload --lifecycle-configuration file://scripts/bucket.lifecycle.json
      - aws s3api put-bucket-cors  --bucket quietthyme-api-${CIRCLE_BRANCH}-upload --cors-configuration file://scripts/bucket.cors.json
      - aws s3api put-bucket-cors  --bucket quietthyme-api-${CIRCLE_BRANCH}-content --cors-configuration file://scripts/bucket.readonly.cors.json
      - curl https://api.rollbar.com/api/1/deploy/ -F access_token=$ROLLBAR_PUSH_API_KEY -F environment=$CIRCLE_BRANCH -F revision=$CIRCLE_SHA1 -F local_username=circleci