machine:
  services:
    - docker
  node:
    version: 4.3.0

dependencies:
  override:
    - npm install -g serverless
    - npm install
    - npm ls || true
# pull docker images needed for tests.
    - docker pull vidsyhq/fake-dynamodb
    - docker pull lphoward/fake-s3

test:
  override:
    - docker run -d -p 6001:6001 vidsyhq/fake-dynamodb
    - docker run -d lphoward/fake-s3
    - sleep 2
    - curl localhost:6001
    - npm test

deployment:
  deploy:
    branch: [beta, master]
    commands:
      - npm prune --production #prune node_modules directory to only contain production modules
      - sls prune -n 4
      - serverless deploy --stage $CIRCLE_BRANCH --region us-east-1